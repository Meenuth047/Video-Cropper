<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Cropper - Accurate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
    <div class="max-w-5xl mx-auto p-8">
        <h1 class="text-4xl font-bold text-white mb-2 text-center">Interactive Video Cropper</h1>
        <p class="text-purple-200 text-center mb-8">Select any 2-minute segment from your video</p>

        <div id="app">
            <div id="uploadSection" class="bg-white/10 backdrop-blur-lg rounded-2xl p-12 border border-white/20 text-center">
                <svg class="w-16 h-16 text-purple-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <label class="cursor-pointer">
                    <input type="file" id="videoInput" accept="video/*" class="hidden">
                    <div class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-4 rounded-lg inline-block transition-colors font-semibold">
                        Select Video File
                    </div>
                </label>
                <p class="text-purple-200 mt-4">Choose a video from your RGB_videos folder</p>
            </div>

            <div id="playerSection" class="space-y-6 hidden">
                <div id="videoContainer" class="bg-black rounded-2xl overflow-hidden shadow-2xl relative">
                    <video id="videoPlayer" class="w-full" controls></video>
                    
                    <!-- Skip buttons overlay on video - hidden by default -->
                    <button id="backward10Btn" class="skip-btn-left absolute top-1/2 left-8 transform -translate-y-1/2 bg-gray-800/80 text-white w-20 h-20 rounded-full transition-all flex flex-col items-center justify-center shadow-2xl opacity-0 pointer-events-none z-10">
                        <svg class="w-8 h-8 mb-1" fill="white" viewBox="0 0 24 24">
                            <path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/>
                        </svg>
                        <span class="text-xs font-semibold">10 seconds</span>
                    </button>
                    
                    <button id="forward10Btn" class="skip-btn-right absolute top-1/2 right-8 transform -translate-y-1/2 bg-gray-800/80 text-white w-20 h-20 rounded-full transition-all flex flex-col items-center justify-center shadow-2xl opacity-0 pointer-events-none z-10">
                        <svg class="w-8 h-8 mb-1" fill="white" viewBox="0 0 24 24">
                            <path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/>
                        </svg>
                        <span class="text-xs font-semibold">10 seconds</span>
                    </button>
                </div>

                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div class="flex items-center gap-4 mb-4">
                        <button id="playPauseBtn" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full transition-colors">
                            <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                            </svg>
                        </button>
                        
                        <div class="flex-1">
                            <input type="range" id="seekBar" min="0" max="100" value="0" 
                                   class="w-full h-2 bg-purple-300 rounded-lg appearance-none cursor-pointer slider">
                            <div class="flex justify-between text-purple-200 text-sm mt-1">
                                <span id="currentTimeDisplay">00:00</span>
                                <span id="durationDisplay">00:00</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/5 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-white font-semibold">Set Time Points</h3>
                            <button id="toggleManualBtn" class="text-blue-300 hover:text-blue-200 text-sm underline">
                                Manual Entry
                            </button>
                        </div>
                        
                        <div id="buttonMode" class="grid grid-cols-2 gap-4">
                            <div>
                                <button id="setStartBtn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition-colors font-semibold">
                                    Set Start Point
                                </button>
                                <p id="startTimeDisplay" class="text-green-300 text-sm mt-2 text-center hidden"></p>
                            </div>
                            <div>
                                <button id="setEndBtn" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg transition-colors font-semibold">
                                    Set End Point
                                </button>
                                <p id="endTimeDisplay" class="text-red-300 text-sm mt-2 text-center hidden"></p>
                            </div>
                        </div>
                        
                        <div id="manualMode" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-green-300 text-sm block mb-2">Start Time (MM:SS)</label>
                                    <input type="text" id="manualStartInput" placeholder="15:06" 
                                           class="w-full bg-white/10 border border-green-500/50 rounded-lg px-3 py-2 text-white text-center focus:outline-none focus:border-green-500">
                                </div>
                                <div>
                                    <label class="text-red-300 text-sm block mb-2">End Time (MM:SS)</label>
                                    <input type="text" id="manualEndInput" placeholder="17:06" 
                                           class="w-full bg-white/10 border border-red-500/50 rounded-lg px-3 py-2 text-white text-center focus:outline-none focus:border-red-500">
                                </div>
                            </div>
                            <button id="applyManualBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors font-semibold">
                                Apply Times
                            </button>
                            <p class="text-purple-200 text-xs text-center">Format: MM:SS (e.g., 15:06 or 1:23:45 for hours)</p>
                        </div>
                    </div>

                    <div id="selectionInfo" class="bg-purple-600/30 rounded-lg p-4 mb-4 hidden">
                        <div class="flex items-center justify-between text-white">
                            <div>
                                <p class="text-sm text-purple-200">Selected Duration:</p>
                                <p class="text-2xl font-bold" id="durationValue">00:00</p>
                            </div>
                            <div>
                                <p class="text-sm text-purple-200">Range:</p>
                                <p class="font-semibold" id="rangeValue">00:00 → 00:00</p>
                            </div>
                        </div>
                        <p id="warningText" class="text-yellow-300 text-sm mt-2 hidden"></p>
                    </div>

                    <div class="bg-blue-600/20 rounded-lg p-4 mb-4">
                        <p class="text-blue-200 font-semibold mb-2">Cropping Method:</p>
                        <div class="space-y-2">
                            <label class="flex items-center text-white cursor-pointer">
                                <input type="radio" name="method" value="accurate" checked class="mr-3">
                                <div>
                                    <span class="font-semibold">Accurate (Recommended)</span>
                                    <span class="text-blue-200 text-sm block">Frame-perfect, but slower (re-encodes)</span>
                                </div>
                            </label>
                            <label class="flex items-center text-white cursor-pointer">
                                <input type="radio" name="method" value="fast" class="mr-3">
                                <div>
                                    <span class="font-semibold">Fast</span>
                                    <span class="text-blue-200 text-sm block">Quick but may be off by a few seconds</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <button id="cropBtn" disabled 
                            class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-4 rounded-lg transition-colors font-bold text-lg flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z"></path>
                        </svg>
                        Get Crop Instructions
                    </button>
                </div>

                <div class="text-center">
                    <label class="cursor-pointer">
                        <input type="file" id="videoInput2" accept="video/*" class="hidden">
                        <div class="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-lg inline-block transition-colors border border-white/20">
                            Load Different Video
                        </div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        let video = document.getElementById('videoPlayer');
        let startTime = null;
        let endTime = null;
        let videoFileName = '';

        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('video/')) {
                videoFileName = file.name;
                const url = URL.createObjectURL(file);
                video.src = url;
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('playerSection').classList.remove('hidden');
                startTime = null;
                endTime = null;
                document.getElementById('startTimeDisplay').classList.add('hidden');
                document.getElementById('endTimeDisplay').classList.add('hidden');
                document.getElementById('selectionInfo').classList.add('hidden');
                document.getElementById('cropBtn').disabled = true;
            }
        }

        document.getElementById('videoInput').addEventListener('change', handleFileSelect);
        document.getElementById('videoInput2').addEventListener('change', handleFileSelect);

        document.getElementById('playPauseBtn').addEventListener('click', () => {
            if (video.paused) {
                video.play();
                document.getElementById('playIcon').classList.add('hidden');
                document.getElementById('pauseIcon').classList.remove('hidden');
            } else {
                video.pause();
                document.getElementById('playIcon').classList.remove('hidden');
                document.getElementById('pauseIcon').classList.add('hidden');
            }
        });

        video.addEventListener('timeupdate', () => {
            const current = video.currentTime;
            const duration = video.duration;
            document.getElementById('seekBar').value = (current / duration) * 100;
            document.getElementById('currentTimeDisplay').textContent = formatTime(current);
            
            const percent = (current / duration) * 100;
            document.getElementById('seekBar').style.background = 
                `linear-gradient(to right, #9333ea ${percent}%, #d8b4fe ${percent}%)`;
        });

        video.addEventListener('loadedmetadata', () => {
            document.getElementById('durationDisplay').textContent = formatTime(video.duration);
        });

        document.getElementById('seekBar').addEventListener('input', (e) => {
            const time = (e.target.value / 100) * video.duration;
            video.currentTime = time;
        });

        // 10 second skip buttons
        document.getElementById('backward10Btn').addEventListener('click', () => {
            video.currentTime = Math.max(0, video.currentTime - 10);
        });

        document.getElementById('forward10Btn').addEventListener('click', () => {
            video.currentTime = Math.min(video.duration, video.currentTime + 10);
        });

        // Show/hide skip buttons on mouse move over video
        const videoContainer = document.getElementById('videoContainer');
        const backwardBtn = document.getElementById('backward10Btn');
        const forwardBtn = document.getElementById('forward10Btn');
        let hideButtonsTimeout;

        videoContainer.addEventListener('mousemove', (e) => {
            const rect = videoContainer.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const containerWidth = rect.width;
            const leftZone = containerWidth * 0.3; // Left 30%
            const rightZone = containerWidth * 0.7; // Right 70%
            
            // Show buttons with pointer events when mouse is in zones
            if (mouseX < leftZone) {
                backwardBtn.style.opacity = '1';
                backwardBtn.style.pointerEvents = 'auto';
            } else {
                backwardBtn.style.opacity = '0';
                backwardBtn.style.pointerEvents = 'none';
            }
            
            if (mouseX > rightZone) {
                forwardBtn.style.opacity = '1';
                forwardBtn.style.pointerEvents = 'auto';
            } else {
                forwardBtn.style.opacity = '0';
                forwardBtn.style.pointerEvents = 'none';
            }
            
            // Clear existing timeout
            clearTimeout(hideButtonsTimeout);
            
            // Hide buttons after 1 second of no movement
            hideButtonsTimeout = setTimeout(() => {
                backwardBtn.style.opacity = '0';
                backwardBtn.style.pointerEvents = 'none';
                forwardBtn.style.opacity = '0';
                forwardBtn.style.pointerEvents = 'none';
            }, 1000);
        });

        videoContainer.addEventListener('mouseleave', () => {
            backwardBtn.style.opacity = '0';
            backwardBtn.style.pointerEvents = 'none';
            forwardBtn.style.opacity = '0';
            forwardBtn.style.pointerEvents = 'none';
            clearTimeout(hideButtonsTimeout);
        });

        // Toggle manual entry mode
        document.getElementById('toggleManualBtn').addEventListener('click', () => {
            const buttonMode = document.getElementById('buttonMode');
            const manualMode = document.getElementById('manualMode');
            const toggleBtn = document.getElementById('toggleManualBtn');
            
            if (buttonMode.classList.contains('hidden')) {
                buttonMode.classList.remove('hidden');
                manualMode.classList.add('hidden');
                toggleBtn.textContent = 'Manual Entry';
            } else {
                buttonMode.classList.add('hidden');
                manualMode.classList.remove('hidden');
                toggleBtn.textContent = 'Button Mode';
            }
        });

        // Parse time string (MM:SS or HH:MM:SS) to seconds
        function parseTimeString(timeStr) {
            const parts = timeStr.trim().split(':').map(p => parseInt(p));
            if (parts.length === 2) {
                // MM:SS
                return parts[0] * 60 + parts[1];
            } else if (parts.length === 3) {
                // HH:MM:SS
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return null;
        }

        // Apply manual time entry
        document.getElementById('applyManualBtn').addEventListener('click', () => {
            const startInput = document.getElementById('manualStartInput').value;
            const endInput = document.getElementById('manualEndInput').value;
            
            const parsedStart = parseTimeString(startInput);
            const parsedEnd = parseTimeString(endInput);
            
            if (parsedStart === null || parsedEnd === null) {
                alert('Invalid time format! Use MM:SS (e.g., 15:06) or HH:MM:SS (e.g., 1:23:45)');
                return;
            }
            
            if (parsedStart >= parsedEnd) {
                alert('Start time must be before end time!');
                return;
            }
            
            if (parsedEnd > video.duration) {
                alert(`End time (${endInput}) exceeds video duration (${formatTime(video.duration)})!`);
                return;
            }
            
            startTime = parsedStart;
            endTime = parsedEnd;
            
            document.getElementById('startTimeDisplay').textContent = `Start: ${formatTime(startTime)}`;
            document.getElementById('startTimeDisplay').classList.remove('hidden');
            document.getElementById('endTimeDisplay').textContent = `End: ${formatTime(endTime)}`;
            document.getElementById('endTimeDisplay').classList.remove('hidden');
            
            updateSelectionInfo();
            
            // Jump video to start time
            video.currentTime = startTime;
        });

        document.getElementById('setStartBtn').addEventListener('click', () => {
            startTime = video.currentTime;
            document.getElementById('startTimeDisplay').textContent = `Start: ${formatTime(startTime)}`;
            document.getElementById('startTimeDisplay').classList.remove('hidden');
            
            const proposedEnd = startTime + 120;
            endTime = Math.min(proposedEnd, video.duration);
            document.getElementById('endTimeDisplay').textContent = `End: ${formatTime(endTime)}`;
            document.getElementById('endTimeDisplay').classList.remove('hidden');
            
            updateSelectionInfo();
        });

        document.getElementById('setEndBtn').addEventListener('click', () => {
            endTime = video.currentTime;
            document.getElementById('endTimeDisplay').textContent = `End: ${formatTime(endTime)}`;
            document.getElementById('endTimeDisplay').classList.remove('hidden');
            updateSelectionInfo();
        });

        function updateSelectionInfo() {
            if (startTime !== null && endTime !== null) {
                const duration = Math.abs(endTime - startTime);
                document.getElementById('selectionInfo').classList.remove('hidden');
                document.getElementById('durationValue').textContent = formatTime(duration);
                document.getElementById('rangeValue').textContent = 
                    `${formatTime(startTime)} → ${formatTime(endTime)}`;
                
                if (duration > 120) {
                    document.getElementById('warningText').textContent = 
                        `⚠ Duration exceeds 2 minutes (${formatTime(duration)})`;
                    document.getElementById('warningText').classList.remove('hidden');
                } else {
                    document.getElementById('warningText').classList.add('hidden');
                }
                
                document.getElementById('cropBtn').disabled = false;
            }
        }

        document.getElementById('cropBtn').addEventListener('click', () => {
            const duration = Math.abs(endTime - startTime);
            const method = document.querySelector('input[name="method"]:checked').value;
            
            let ffmpegCommand, pythonCode, explanation;
            
            if (method === 'accurate') {
                // Accurate method: -ss BEFORE -i, re-encode for frame accuracy
                ffmpegCommand = `ffmpeg -ss ${startTime.toFixed(2)} -i "${videoFileName}" -t ${duration.toFixed(2)} -c:v libx264 -c:a aac "cropped_${videoFileName}"`;
                explanation = `ACCURATE METHOD (Frame-Perfect):
This will take longer but gives you EXACTLY the frames you selected.
The -ss is placed BEFORE -i for accurate seeking, and re-encodes the video.`;
                
                pythonCode = `from moviepy.editor import VideoFileClip
video = VideoFileClip("${videoFileName}")
cropped = video.subclip(${startTime.toFixed(2)}, ${endTime.toFixed(2)})
cropped.write_videofile("cropped_${videoFileName}", codec='libx264', audio_codec='aac')`;
            } else {
                // Fast method: -ss BEFORE -i, but with -c copy for speed
                ffmpegCommand = `ffmpeg -ss ${startTime.toFixed(2)} -i "${videoFileName}" -t ${duration.toFixed(2)} -c copy "cropped_${videoFileName}"`;
                explanation = `FAST METHOD (Quick but approximate):
This is very fast but may be off by 1-3 seconds due to keyframe seeking.
Use this for quick previews, then use Accurate method for final cuts.`;
                
                pythonCode = `from moviepy.editor import VideoFileClip
video = VideoFileClip("${videoFileName}")
cropped = video.subclip(${startTime.toFixed(2)}, ${endTime.toFixed(2)})
cropped.write_videofile("cropped_${videoFileName}")`;
            }

            const instructions = `VIDEO CROP INSTRUCTIONS
========================
Video: ${videoFileName}
Start time: ${formatTime(startTime)} (${startTime.toFixed(2)} seconds)
End time: ${formatTime(endTime)} (${endTime.toFixed(2)} seconds)
Duration: ${formatTime(duration)} (${duration.toFixed(2)} seconds)

${explanation}

OPTION 1: Using FFmpeg (recommended)
-------------------------------------
Install FFmpeg if you haven't: https://ffmpeg.org/download.html

Command to run in your terminal:

${ffmpegCommand}

This will create: cropped_${videoFileName}


OPTION 2: Using Python (moviepy)
---------------------------------
First install moviepy:
pip install moviepy

Then run this Python code:

${pythonCode}


TROUBLESHOOTING:
----------------
1. If the cropped video is the wrong segment:
   - Use the ACCURATE method above
   - Make sure you noted the correct start/end times

2. If FFmpeg gives errors:
   - Remove the output file if it exists
   - Try without -c copy: add -c:v libx264 -c:a aac

3. For best results:
   - Always use ACCURATE method for final production
   - Use FAST method only for quick previews

4. To verify your crop before processing:
   - Play the original video and manually check timestamps
   - The times shown in this tool match the video player timestamps
`;

            const blob = new Blob([instructions], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crop_instructions_${method}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`${method === 'accurate' ? 'ACCURATE' : 'FAST'} crop instructions downloaded!\n\nCheck the text file for the command to crop your video.\n\n${method === 'accurate' ? 'This will give you frame-perfect accuracy but takes longer.' : 'This is fast but may be off by a few seconds.'}`);
        });
    </script>
</body>
</html>